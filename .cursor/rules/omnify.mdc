---
alwaysApply: true
---
<omnify-guidelines>
# Omnify Architecture Rules (CRITICAL)

## Single Source of Truth

The YAML schema files in `./database/schemas/Sso/` are the **single source of truth** for the database schema.
All migrations, models, requests, resources, and TypeScript types are generated from these schemas.

## Workflow

1. Edit schema YAML files in `./database/schemas/Sso/`
2. Run `omnify validate` to check for errors
3. Run `omnify generate` to generate migrations + codegen

## NEVER Do These

- **NEVER** create or edit migration files directly — edit the schema YAML, then run `omnify generate`
- **NEVER** edit auto-generated files (they get overwritten on next generate)
- **NEVER** edit `schemas.json`, `.omnify/lock.json`, or `.omnify/versions/` — managed by omnify
- **NEVER** manually write SQL DDL (CREATE TABLE, ALTER TABLE) — omnify handles this
- **NEVER** manually write Policy PHP files — define `policies` in schema YAML, omnify generates them

## How To

- **Add a column**: Add a property in the schema YAML → `omnify generate`
- **Add a relation**: Add an Association property in the schema YAML → `omnify generate`
- **Add an enum**: Create a new YAML file with `kind: enum` → reference it with `type: EnumRef`
- **Add a table**: Create a new YAML schema file → `omnify generate`
- **Rename a column**: Change the property name in YAML → `omnify generate --force`
- **Add an index**: Add to `options.indexes` in the schema YAML
- **Add a policy**: Add `policies` block to the schema YAML → `omnify generate` (generates Laravel Policy classes)

# Generated Files (DO NOT EDIT)

The following files and directories are auto-generated by omnify. Do not edit them manually — changes will be lost on next `omnify generate`.

## Migration Files
- `database/migrations/omnify/` — Laravel PHP migrations
- `migrations/` — Raw SQL migrations (if configured)

## Base Files (overwritten on every generate)
- `**/Base/*.php` — Base Eloquent models (includes `{Model}TranslationBaseModel.php` for translatable schemas)
- `**/OmnifyBase/*.php` — Base Form Requests and API Resources
- `**/base/*.ts` — Base TypeScript files
- `**/Omnify/*.php` — Generated model files (includes `{Model}Translation.php` for translatable schemas)
- `**/Policies/Omnify/Base/{Name}PolicyBase.php` — Base Policy classes (Cedar-style ABAC, overwritten on every generate)

## Data Files
- `database/omnify/schemas.json` — Serialized schema data
- `.omnify/lock.json` — Lock file (change tracking)
- `.omnify/versions/` — Version snapshots

## Editable Extension Files
These files are generated **once** and are safe to customize:
- `app/Models/*.php` (without Base/ or Omnify/ prefix) — Your custom model extensions
- `app/Http/Requests/*Request.php` (without OmnifyBase/) — Your custom request extensions
- `app/Http/Resources/*Resource.php` (without OmnifyBase/) — Your custom resource extensions
- `app/Policies/Omnify/{Name}Policy.php` — Your custom policy extensions (extends base policy)
- `database/factories/*Factory.php` — Your custom factory extensions

# Schema Design Guide

## Schema Kinds

| Kind | Purpose | Key Fields |
|------|---------|------------|
| `object` (default) | Database table with columns | properties, options, associations |
| `enum` | Enum type (no table) | values (simple list or with labels) |
| `pivot` | Join table for ManyToMany | pivotFor: [Model1, Model2], properties |
| `extend` / `partial` | Add fields to existing schema | target, properties, priority |

## Property Types

### String Types
| Type | Description | Key Fields |
|------|-------------|------------|
| String | VARCHAR | length (default: 255) |
| Text | TEXT | - |
| MediumText | MEDIUMTEXT | - |
| LongText | LONGTEXT | - |
| Email | VARCHAR, validated as email | length |
| Password | VARCHAR, hidden | length |
| Uuid | UUID/CHAR(36) | - |

### Numeric Types
| Type | Description | Key Fields |
|------|-------------|------------|
| TinyInt | TINYINT | unsigned |
| Int | INT | unsigned |
| BigInt | BIGINT | unsigned |
| Float | FLOAT | - |
| Decimal | DECIMAL | precision, scale, unsigned |
| Boolean | BOOLEAN | - |

### Date/Time Types
| Type | Description | Key Fields |
|------|-------------|------------|
| Date | DATE | - |
| Time | TIME | - |
| DateTime | DATETIME | useCurrent, useCurrentOnUpdate |
| Timestamp | TIMESTAMP | useCurrent, useCurrentOnUpdate |

### Other Types
| Type | Description | Key Fields |
|------|-------------|------------|
| Json | JSON column | - |
| File | File reference (VARCHAR) | multiple, maxFiles, accept, maxSize |
| Point | Spatial POINT | - |
| Coordinates | Lat/Lng pair (JSON) | - |
| Enum | Inline enum | enum: [val1, val2] |
| EnumRef | Reference to enum schema | enum: SchemaName |
| Association | Relationship | relation, target |

### Common Property Fields
- `displayName`: LocalizedString — display name (plain string or locale map `{ja: 名前, en: Name}`)
- `description`: LocalizedString — detailed description (tooltips, help text)
- `placeholder`: LocalizedString — input placeholder text
- `nullable`: Allow NULL (default: false)
- `default`: Default value
- `unique`: Unique constraint
- `hidden`: Hide from API responses
- `fillable`: Allow mass assignment (default: true)
- `translatable`: Enable multi-language translation via Astrotomic/laravel-translatable. Generates a `{model}_translations` table + Translation model. Only allowed on: String, Text, MediumText, LongText, Email, EnumRef, Json
- `rules`: Validation rules — generates both Laravel validation and Zod schemas

### LocalizedString Type
Used by `displayName`, `description`, `placeholder` (on properties), and `label` (on enum values):
```yaml
# Plain string
displayName: Title

# Locale map
displayName:
  ja: タイトル
  en: Title
```

## Associations (Relationships)

| Relation | Creates Column? | Example Use |
|----------|----------------|-------------|
| ManyToOne | Yes (`{name}_id` FK) | Post belongs to User |
| OneToMany | No | User has many Posts |
| OneToOne | Yes (FK + unique) | User has one Profile |
| ManyToMany | No (uses pivot) | Post has many Tags |
| MorphTo | Yes (`{name}_type` + `{name}_id`) | Comment belongs to commentable |
| MorphOne | No | Post has one Image |
| MorphMany | No | Post has many Comments |
| MorphToMany | No (uses pivot) | Post has many Tags (polymorphic) |

### Association Example
```yaml
author:
  type: Association
  relation: ManyToOne
  target: User
  onDelete: CASCADE    # CASCADE, SET NULL, RESTRICT, NO ACTION
```

## Schema Options

```yaml
options:
  id: true              # true (default), false, BigInt, Int, Uuid, Ulid, String
  timestamps: true       # created_at + updated_at (default: true)
  softDelete: true       # deleted_at column
  tableName: custom_name # Override table name
  authenticatable: true  # Laravel Authenticatable trait
  indexes:
    - columns: [email]
    - columns: [status, created_at]
      type: btree        # btree, hash, fulltext, spatial, gin, gist
  unique: [email]        # Unique constraint(s)
```

## Policies (Cedar-style ABAC)

Define authorization policies directly in the schema YAML. Only valid on `kind: object` schemas.

```yaml
policies:
  - permit: [view, list]
    when: status = "published"
    desc: "Published posts are public"
  - permit: [view, edit, delete]
    when: author = $user
    desc: "Authors can manage their own posts"
  - permit: [create]
    desc: "Any authenticated user can create"
  - forbid: [delete]
    when: status = "published"
    desc: "Published posts cannot be deleted"
```

**Actions**: `view`, `list`, `create`, `edit`, `delete`, `*` (all)

**Evaluation order**: forbid first → permit → default deny

**Conditions**: `property = "literal"`, `property != "value"`, `property >= 1000`, `property in ["a", "b"]`, `author = $user` (ManyToOne), `$user in members` (ManyToMany), `$user in org.members` (through), `$user.role = "admin"`, `$ip in cidr(10.0.0.0/8)`, `deadline > $now`

**Multiple conditions (AND)**: Use array `when: [cond1, cond2]`

See the Policies guide topic for full syntax reference.

## Best Practices

- **Schema files**: PascalCase (`Customer.yaml`, `PostStatus.yaml`)
- **Property names**: camelCase in YAML → auto-converted to snake_case in DB
- **Groups**: Use directory structure (`./database/schemas/Sso/blog/Post.yaml`)
- **DisplayName**: Always provide — used for labels, docs, and UI
- **EnumRef vs Enum**: Use EnumRef for shared/localized values, inline Enum for simple schema-specific values
- **Associations**: Always set `onDelete` on ManyToOne (CASCADE or SET NULL)
- **ManyToMany**: Use `joinTable` to control pivot table name

# Real Schema Examples

## Model Schema (Post.yaml)
```yaml
displayName:
  ja: 投稿
  en: Post
group: blog

options:
  softDelete: true
  indexes:
    - columns: [published_at]
    - columns: [status, published_at]

properties:
  title:
    type: String
    translatable: true
    displayName:
      ja: タイトル
      en: Title

  slug:
    type: String
    unique: true

  content:
    type: LongText
    translatable: true

  status:
    type: EnumRef
    enum: PostStatus
    default: draft

  published_at:
    type: Timestamp
    nullable: true

  view_count:
    type: Int
    default: 0
    unsigned: true

  author:
    type: Association
    relation: ManyToOne
    target: User
    onDelete: CASCADE

  tags:
    type: Association
    relation: ManyToMany
    target: Tag
    joinTable: post_tags

  comments:
    type: Association
    relation: MorphMany
    target: Comment
    morphName: commentable
```

## Enum Schema (PostStatus.yaml)
```yaml
kind: enum
displayName:
  ja: 投稿ステータス
  en: Post Status

values:
  - value: draft
    label:
      ja: 下書き
      en: Draft
  - value: published
    label:
      ja: 公開済み
      en: Published
  - value: archived
    label:
      ja: アーカイブ
      en: Archived
```

## Pivot Schema (PostTag.yaml)
```yaml
kind: pivot
pivotFor: [Post, Tag]
displayName: Post Tag

properties:
  sort_order:
    type: Int
    default: 0

options:
  id: false
  timestamps: true
```

## Extend Schema (UserSsoExtend.yaml)
```yaml
kind: extend
target: User

properties:
  ssoId:
    type: String
    unique: true
    displayName:
      ja: SSO ID
      en: SSO ID
  ssoProvider:
    type: String
    displayName:
      ja: SSOプロバイダー
      en: SSO Provider
```

## Schema with Policies (Post.yaml excerpt)
```yaml
options:
  softDelete: true

properties:
  status:
    type: EnumRef
    enum: PostStatus
  author:
    type: Association
    relation: ManyToOne
    target: User
    onDelete: CASCADE

policies:
  - permit: [view, list]
    when: status = "published"
    desc: "Published posts are public"
  - permit: [view, edit, delete]
    when: author = $user
    desc: "Authors can manage their own posts"
  - permit: [create]
    desc: "Any authenticated user can create posts"
  - forbid: [delete]
    when: status = "published"
    desc: "Published posts cannot be deleted"
```

This generates:
- `app/Policies/Omnify/Base/PostPolicyBase.php` — auto-generated, overwritten on every `omnify generate`
- `app/Policies/Omnify/PostPolicy.php` — user-editable, extends base (created once)

# Available Commands

| Command | Description |
|---------|-------------|
| `omnify validate` | Check schemas for errors |
| `omnify generate` | Generate migrations + run codegen |
| `omnify generate --force` | Regenerate all migrations from scratch |
| `omnify generate --migrations-only` | Generate migrations only, skip codegen |
| `omnify diff` | Show pending schema changes |
| `omnify list` | List all schemas |
| `omnify add` | Scaffold a new schema/field/enum |
| `omnify mcp` | Start MCP server (auto-configured for AI assistants) |
</omnify-guidelines>
