# Refactor: Rename SSO Schemas to Cache Pattern

## Overview

Rename `Branch`, `User`, `Team` schemas to `Branch`, `User`, `Team` to clarify these are cached data from Console SSO server. Add new `Organization` schema.

## Why This Change?

- **Clarity**: These models store data **cached** from Console, not the source of truth
- **Consistency**: All cache models follow the same naming convention
- **Organization**: Adding `Organization` completes the cache hierarchy

---

## Checklist

### Phase 1: Schema Files

- [ ] Create `Branch.yaml` (copy from `Branch.yaml`, update displayName)
- [ ] Create `User.yaml` (copy from `User.yaml`, update displayName)
- [ ] Create `Team.yaml` (copy from `Team.yaml`, update displayName)
- [ ] Create `Organization.yaml` (new file)
- [ ] Delete old `Branch.yaml`
- [ ] Delete old `User.yaml`
- [ ] Delete old `Team.yaml`

### Phase 2: Model Files (Editable - `src/Models/`)

- [ ] Rename `Branch.php` → `Branch.php`
- [ ] Rename `User.php` → `User.php`
- [ ] Rename `Team.php` → `Team.php`
- [ ] Create `Organization.php`
- [ ] Update class names inside each file
- [ ] Update `extends` to new BaseModel names

### Phase 3: Base Model Files (Auto-generated - `src/Models/OmnifyBase/`)

These will be regenerated by `npx omnify generate`, but for reference:

- [ ] `BranchBaseModel.php` → `BranchBaseModel.php`
- [ ] `UserBaseModel.php` → `UserBaseModel.php`
- [ ] `TeamBaseModel.php` → `TeamBaseModel.php`
- [ ] Create `OrganizationBaseModel.php`

### Phase 4: Locale Files (Auto-generated - `src/Models/OmnifyBase/Locales/`)

- [ ] `BranchLocales.php` → `BranchLocales.php`
- [ ] `UserLocales.php` → `UserLocales.php`
- [ ] `TeamLocales.php` → `TeamLocales.php`
- [ ] Create `OrganizationLocales.php`

### Phase 5: Update References in Source Files

#### Middleware (`src/Http/Middleware/`)
- [ ] `SetBranchFromHeader.php` - Update `Branch::` → `Branch::`
- [ ] `SsoOrganizationAccess.php` - Update `Branch::` → `Branch::`

#### Controllers (`src/Http/Controllers/`)
- [ ] `SsoBranchController.php` - Update imports and references
- [ ] `Admin/UserRoleAdminController.php` - Update `User::` → `User::`

#### Seeders (`src/Database/Seeders/`)
- [ ] `Concerns/AssignsRoles.php` - Update `User::` → `User::`

#### Cache Classes (`src/Cache/`)
- [ ] `ConsoleTeamsCache.php` - Update `Team::` → `Team::`

#### Traits (`src/Models/Traits/`)
- [ ] `HasConsoleSso.php` - Review for User references
- [ ] `HasTeamPermissions.php` - Review for Team references

### Phase 6: Service Providers

- [ ] `SsoClientServiceProvider.php` - Update model bindings
- [ ] `Providers/SsoClientServiceProvider.php` - Update model bindings
- [ ] `Models/OmnifyBase/BaseModel.php` - Update model registry

### Phase 7: Factories (`src/Database/Factories/`)

- [ ] Rename `BranchFactory.php` → `BranchFactory.php`
- [ ] Rename `UserFactory.php` → `UserFactory.php`
- [ ] Rename `TeamFactory.php` → `TeamFactory.php`
- [ ] Create `OrganizationFactory.php`
- [ ] Update class names and model references inside

### Phase 8: Backward Compatibility Aliases

Add to ServiceProvider:

```php
// Backward compatibility aliases
class_alias(\Omnify\SsoClient\Models\Branch::class, 'Omnify\SsoClient\Models\Branch');
class_alias(\Omnify\SsoClient\Models\User::class, 'Omnify\SsoClient\Models\User');
class_alias(\Omnify\SsoClient\Models\Team::class, 'Omnify\SsoClient\Models\Team');
```

### Phase 9: Migration Script

Create migration for existing installations:

```php
// database/migrations/xxxx_rename_sso_tables_to_cache.php
Schema::rename('branches', 'branches');
Schema::rename('users', 'users');
Schema::rename('teams', 'teams');
// Note: role_user pivot table stays as is
```

### Phase 10: Final Steps

- [ ] Run `npx omnify generate` to regenerate base models
- [ ] Run tests to verify nothing broke
- [ ] Update README/documentation
- [ ] Update CHANGELOG

---

## File Mapping Reference

| Old Path                  | New Path                             |
| ------------------------- | ------------------------------------ |
| `schemas/Sso/Branch.yaml` | `schemas/Sso/Branch.yaml`       |
| `schemas/Sso/User.yaml`   | `schemas/Sso/User.yaml`         |
| `schemas/Sso/Team.yaml`   | `schemas/Sso/Team.yaml`         |
| (new)                     | `schemas/Sso/Organization.yaml` |
| `src/Models/Branch.php`   | `src/Models/Branch.php`         |
| `src/Models/User.php`     | `src/Models/User.php`           |
| `src/Models/Team.php`     | `src/Models/Team.php`           |
| (new)                     | `src/Models/Organization.php`   |

## Table Name Changes

| Old Table   | New Table             |
| ----------- | --------------------- |
| `branches`  | `branches`       |
| `users`     | `users`         |
| `teams`     | `teams`         |
| (new)       | `organizations` |
| `role_user` | `role_user`     |

---

## Organization Schema

```yaml
# Organization - cached from Console API
# Stores basic organization info for local lookup

kind: object

displayName:
  ja: 組織キャッシュ
  en: Organization Cache
  vi: Cache Tổ chức

options:
  timestamps: true
  softDelete: true
  idType: Uuid
  indexes:
    - columns: [code]
      unique: true

properties:
  console_organization_id:
    type: Uuid
    unique: true
    displayName:
      ja: Console Organization ID
      en: Console Organization ID
      vi: Console Organization ID
    description:
      ja: Console側の組織ID
      en: Organization ID from Console
      vi: ID tổ chức từ Console

  name:
    type: String
    length: 100
    displayName:
      ja: 組織名
      en: Organization Name
      vi: Tên tổ chức

  code:
    type: String
    length: 20
    displayName:
      ja: 組織コード
      en: Organization Code
      vi: Mã tổ chức
    description:
      ja: ユニークな組織コード
      en: Unique organization code
      vi: Mã tổ chức duy nhất

  is_active:
    type: Boolean
    default: true
    displayName:
      ja: 有効
      en: Active
      vi: Hoạt động
```

---

## Breaking Changes Warning

### For Client Applications

Apps that currently extend the SSO User model need to update:

```php
// Before
use Omnify\SsoClient\Models\User;

class User extends \Omnify\SsoClient\Models\User
{
    // ...
}

// After
use Omnify\SsoClient\Models\User;

class User extends User
{
    // ...
}
```

The backward compatibility aliases will help during transition, but apps should migrate to the new names.
